<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="Kartoza" name="author"/>
<link href="../../../img/favicon.ico" rel="shortcut icon"/>
<title>Using Rancher, K3S, and Longhorn for single node Kubernetes deployment - Kartoza Handbook</title>
<link href="../../../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../../../css/font-awesome.min.css" rel="stylesheet"/>
<link href="../../../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" rel="stylesheet"/>
<script defer="" src="../../../js/jquery-1.10.2.min.js"></script>
<script defer="" src="../../../js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<link href="../../../../pdfs/TheKartozaHandbook.pdf" rel="alternate" title="PDF" type="application/pdf"/></head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="../../..">Kartoza Handbook</a>
<!-- Expander button -->
<button class="navbar-toggler" data-target="#navbar-collapse" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Home <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../..">Home</a>
</li>
<li>
<a class="dropdown-item" href="../../../about_kartoza.md">About Kartoza</a>
</li>
<li>
<a class="dropdown-item" href="../../../contributing/">Contributing</a>
</li>
<li>
<a class="dropdown-item" href="../../../polyglot/">Polyglot</a>
</li>
</ul>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Company <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../../company/kartoza/">Kartoza</a>
</li>
<li>
<a class="dropdown-item" href="../../../company/kartoza/strategic_objective/">Strategic Objective</a>
</li>
<li>
<a class="dropdown-item" href="../../../company/kartoza/operating_principles/">Operating Principles</a>
</li>
<li>
<a class="dropdown-item" href="../../../company/kartoza/setting_up_your_computer/">Staff Computers</a>
</li>
</ul>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">GIS <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../../gis/">GIS</a>
</li>
<li>
<a class="dropdown-item" href="../../../gis/cartography/">Cartography</a>
</li>
<li>
<a class="dropdown-item" href="../../../gis/technologies/">Technologies</a>
</li>
<li>
<a class="dropdown-item" href="../../../gis/resources/">Resources</a>
</li>
</ul>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Development <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../../development/">Development</a>
</li>
<li>
<a class="dropdown-item" href="../../../development/conventions/">Conventions</a>
</li>
<li>
<a class="dropdown-item" href="../../../development/technologies/">Languages</a>
</li>
<li>
<a class="dropdown-item" href="../../../development/environments/">Environments</a>
</li>
</ul>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">DevOps <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../">DevOps</a>
</li>
<li>
<a class="dropdown-item" href="../../security/">Security</a>
</li>
<li>
<a class="dropdown-item" href="../../procedures/">Procedures</a>
</li>
<li>
<a class="dropdown-item" href="../">Infrastructure</a>
</li>
</ul>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Resources <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../../library/">Resources</a>
</li>
<li>
<a class="dropdown-item" href="../../../library/cheatsheets/">Cheatsheets</a>
</li>
<li>
<a class="dropdown-item" href="../../../library/tutorials/">Tutorials</a>
</li>
<li>
<a class="dropdown-item" href="../../../library/media/">Media</a>
</li>
<li>
<a class="dropdown-item" href="../../../library/links/">Links</a>
</li>
</ul>
</li>
</ul>
<ul class="nav navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" href="https://github.com/kartoza/TheKartozaHandbook/blob/main/docs/devops/infrastructure/rancher-k3s-single-node.md">Edit on Kartoza Handbook</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-target="#toc-collapse" data-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-secondary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-level="1"><a class="nav-link" href="#using-rancher-k3s-and-longhorn-for-single-node-kubernetes-deployment">Using Rancher, K3S, and Longhorn for single node Kubernetes deployment</a>
<ul class="nav flex-column">
<li class="nav-item" data-level="2"><a class="nav-link" href="#rancher-deployment-process">Rancher Deployment Process</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#application-deployment-process">Application Deployment Process</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="using-rancher-k3s-and-longhorn-for-single-node-kubernetes-deployment">Using Rancher, K3S, and Longhorn for single node Kubernetes deployment</h1>
<p>Prerequisites: This process assumes the use of a clean Ubuntu 20.04 server with a public IP address and an authorized key recognised by the server in the current users ~/.ssh.</p>
<h2 id="rancher-deployment-process">Rancher Deployment Process</h2>
<p>Get the docker-ansible project to run an ansible controller in a docker container</p>
<pre><code class="language-bash">user@dev$ git clone https://github.com/kartoza/docker-ansible.git
</code></pre>
<p>Build the container image</p>
<pre><code class="language-bash">user@dev$ cd docker-ansible
</code></pre>
<pre><code class="language-bash">user@dev$ docker build . -t ansible
</code></pre>
<p>Replace the remote IP address in the inventory file</p>
<pre><code class="language-bash">user@dev$ echo "&lt;server-ip&gt; ansible_user=root ansible_private_key_file=/root/.ssh/id_ed25519" &gt; ${PWD}/ansible/inventory/hosts.ini
</code></pre>
<p>Remove the default playbooks directory</p>
<pre><code>user@dev$ rm -r ./ansible/playbooks
</code></pre>
<p>Fetch the playbook repository which includes the singlenode rancher deployment</p>
<pre><code class="language-bash">user@dev$ cd ./ansible &amp;&amp; git clone https://github.com/kartoza/playbooks.git
</code></pre>
<p>Go back to the repository root</p>
<pre><code class="language-bash">user@dev$ cd /..
</code></pre>
<p>Run the docker container (Powershell/ Windows users should read the <a href="https://github.com/kartoza/docker-ansible/blob/main/README.md">docker-ansible</a> readme)</p>
<pre><code class="language-bash">user@dev$ docker run -dt -v $PWD/ansible:/ansible \
               -v ~/.ssh:/root/win-ssh:ro \
               -e ANSIBLE_CONFIG=/ansible/ansible.cfg \
               --restart=unless-stopped \
               --name ansible ansible
</code></pre>
<p>Once the container is running run the playbook</p>
<pre><code class="language-bash">user@dev$ docker exec -it ansible ansible-playbook /ansible/playbooks/ubuntu20.04/app/rancher-singlenode.yaml
</code></pre>
<p>Save the logs and kill off the ansible container</p>
<pre><code class="language-bash">user@dev$ docker logs ansible &gt;&gt; $PWD/ansible_log.txt &amp;&amp; docker rm -f ansible
</code></pre>
<p>At this point, the server should be configured to use <code>https://rancher.&lt;server-ip&gt;.sslip.io</code>. By default the admin user is <code>admin</code> and the password is <code>chickensoup</code> but that can be changed in the <code>rancher-singlenode.yaml</code> file. Note self-signed TLS is enabled so there'll be browser notices, but TLS configuration is environment specific and not considered in the scope of this process definition.</p>
<h2 id="application-deployment-process">Application Deployment Process</h2>
<p>Now the project workload will need to be deployed to the server. This will use kubectl and can be done in various ways. If you wish to deploy from the local machine, the kubectl configuration for each node should be available in the <code>ansible/data</code> directory.</p>
<p>For the purpose of demonstrating this process, it is assumed that this is done by using ssh to connect to the server as the root user, which should have the kubectl configuration already setup by the ansible deployment.</p>
<pre><code class="language-bash">user@dev$ ssh root@&lt;server-ip&gt;
</code></pre>
<p>Clone the project repository</p>
<pre><code class="language-bash">root@app-srv$ mkdir /manifests &amp;&amp; cd /manifests &amp;&amp; git clone https://gitlab.com/zacharlie/test-manifest.git
</code></pre>
<p>Replace the hostname field in the ingress with the fully qualified domain name of the server.</p>
<pre><code class="language-bash">root@app-srv$ cp /manifests/test-manifest/ingress.yaml /manifests/test-manifest/ingress.yaml.bak &amp;&amp; awk '/nginx.test.localhost/ {sub("nginx.test.localhost", "123.456.7.89.sslip.io", $0)} {print}' /manifests/test-manifest/ingress.yaml.bak &gt; /manifests/test-manifest/ingress.yaml
</code></pre>
<p>Apply the project resources using kustomize</p>
<pre><code class="language-bash">root@app-srv$ cd /manifests/test-manifest &amp;&amp; kubectl apply -k .
</code></pre>
<p>Be patient and monitor the resources from the nifty rancher dashboard (Workload &gt;&gt; Pods is a good place to start). Once everything is running you may view the landing page at the hostname address that was configured within the ingress configuration.</p>
<p><img alt="Hello World from Nginx" src="https://user-images.githubusercontent.com/64078329/170362614-65f290bc-d3a1-42cc-8f78-640cd958e52a.png"/></p></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Kartoza and Contributors</p>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script defer="" src="../../../js/base.js"></script>
<div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">Ã—</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
</body>
</html>
